# Отчет по исправлению интеграции вебхука Prodamus

## Описание проблемы

После успешной оплаты через Prodamus пользователи не видели результаты анализа чакр, а статусы заказов не обновлялись. В логах сервера фиксировались ошибки 404 при попытке платёжной системы обратиться к вебхуку по адресам `/payments/webhook` и `/api/payments/webhook`.

## Причины проблемы

- В коде FastAPI обработчик вебхука был зарегистрирован с префиксом `/api` (`/api/payments/webhook`).
- В файле `main.py` роутеры подключались **без** префикса `/api`, из-за чего эндпоинт не находился.
- В настройках Prodamus был указан URL вебхука без учёта префикса `/api`.
- Сервер несколько раз перезапускался, и в момент отправки некоторых вебхуков (например, для заказа TEST-006) сервер ещё не был обновлён, поэтому вебхук не сработал.

## Ход исправления

1. В файле `main.py` исправили подключение роутеров:
    ```python
    app.include_router(payments_router, prefix="/api")
    app.include_router(webhooks_router, prefix="/api")
    ```
2. Убедились, что сам обработчик вебхука слушает путь `/api/payments/webhook`.
3. В настройках Prodamus указали правильный URL вебхука: `https://<ваш-домен>/api/payments/webhook`.
4. Перезапустили сервер после внесения изменений.
5. Проверили по логам:
    - Для заказа **TEST-005** вебхук сработал, заказ был найден, статус обновлён, ошибок не возникло.
    - Для заказа **TEST-006** вебхук не дошёл (404), потому что сервер был не обновлён в момент отправки.

## Итог

- Проблема была в несовпадении путей и отсутствии префикса `/api` при регистрации роутеров.
- После исправления и перезапуска сервера вебхук стал работать корректно.
- Для старых заказов, где вебхук не сработал, требуется вручную повторно отправить вебхук (например, с помощью curl или Postman).

## Рекомендации

- Всегда проверять соответствие путей в коде и настройках платёжной системы.
- После изменений в роутинге обязательно перезапускать сервер.
- Для тестирования использовать инструменты curl/Postman или функцию повторной отправки вебхука в личном кабинете Prodamus.

## Как запустить ngrok для тестирования вебхука

1. Убедитесь, что ngrok установлен. Если не установлен, скачайте с https://ngrok.com/download и установите.
2. Откройте терминал и перейдите в папку, где находится исполняемый файл ngrok (или добавьте ngrok в PATH).
3. Запустите команду для проброса локального сервера FastAPI (обычно на порту 8000):

   ```sh
   .\ngrok.exe http 8000
   ```

4. В терминале появится публичный адрес вида `https://xxxx-xx-xx-xx.ngrok-free.app`. Используйте этот адрес для настройки вебхука в Prodamus:
   - Пример: `https://xxxx-xx-xx-xx.ngrok-free.app/api/payments/webhook`

5. Пока окно ngrok открыто, все запросы снаружи будут перенаправляться на ваш локальный сервер.

---

**Ответственный за исправление:**
- [Ваше имя]
- Дата: [Текущая дата] 