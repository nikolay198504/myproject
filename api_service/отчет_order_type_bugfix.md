# Отчёт: Исправление ошибки с отображением результатов платных заказов (personal/compatibility) после оплаты

## Описание проблемы

В проекте реализованы два типа платных заказов: персональный анализ (`personal`) и совместимость (`compatibility`). После оплаты пользователь возвращается на сайт с параметром `order_id` в URL. Фронтенд должен определить тип заказа и вызвать соответствующую polling-функцию для получения результата:
- `pollPaidInterpretation` для персонального анализа
- `pollCompatibilityResult` для совместимости

### Симптомы

- После оплаты результат персонального анализа отображался корректно, а результат совместимости — нет.
- Иногда для совместимости отображался результат персонального анализа или наоборот.
- В некоторых случаях результат не появлялся вовсе, либо появлялись ошибки 400 (Bad Request) от API.
- Проблема проявлялась особенно часто при возврате на сайт после оплаты или при открытии ссылки с order_id в новом окне.

## Причины

1. **Ненадёжное определение типа заказа на фронте**
    - Тип заказа (`orderType`) сохранялся только в localStorage при создании заказа.
    - После возврата с платёжной системы или при открытии сайта в новом окне localStorage мог быть пуст или содержать устаревшие данные.
    - Фронтенд пытался "угадать" тип заказа по points или localStorage, что приводило к ошибкам.

2. **Отсутствие серверного API для получения типа заказа**
    - Не было возможности по order_id узнать тип заказа с сервера.
    - Вся логика выбора polling-функции строилась на предположениях фронта.

## Решение

1. **Реализован новый эндпоинт на FastAPI:**
    ```python
    @app.get("/payments/order-type")
    async def get_order_type(order_id: str):
        db = SessionLocal()
        try:
            id_int = int(order_id.replace("ORD-", ""))
            order = db.query(Order).filter(Order.id == id_int).first()
            if not order:
                return JSONResponse(status_code=404, content={"error": "Order not found"})
            return {"type": order.type}
        finally:
            db.close()
    ```
    - Позволяет по order_id получить тип заказа (`personal` или `compatibility`).

2. **Изменена логика на фронте (`calc_v2.js`):**
    - При наличии order_id, но отсутствии orderType в localStorage, фронт делает запрос к `/api/payments/order-type`.
    - После получения типа заказа вызывает нужную polling-функцию:
        ```js
        if (orderType === "compatibility") {
          pollCompatibilityResult(orderId, 120, 3000);
        } else if (orderType === "personal") {
          pollPaidInterpretation(orderId, 120, 3000);
        } else {
          addBotMessage("Не удалось определить тип заказа...");
        }
        ```

## Результат

- polling-функция всегда соответствует реальному типу заказа.
- Результаты отображаются корректно для обоих типов заказов, вне зависимости от состояния localStorage или способа возврата пользователя на сайт.
- Ошибки с неправильным результатом или его отсутствием устранены.

## Вывод

Проблема была вызвана тем, что фронтенд не мог гарантированно определить тип заказа только по localStorage.  
Решение — добавить серверный эндпоинт для получения типа заказа и вызывать polling-функцию строго по фактическому типу.  
Это сделало логику устойчивой и устранило баги с отображением результатов.

---

_Дата: {{DATE}}_