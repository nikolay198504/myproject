# История интеграции Prodamus и автоматизации оплаты

## Краткое описание задачи

- Требовалось реализовать автоматическую оплату через Prodamus, чтобы пользователь не вводил номер заказа и сумму вручную, а бот и backend всё делали автоматически.
- В процессе обсуждения были рассмотрены все этапы: генерация заказа, формирование ссылки, интеграция с API-инвойсами Prodamus, обработка вебхука, отображение результата.

---

## Основные этапы переписки и решения

1. **Проблема:**
   - Пользователь сначала вручную создавал заказ в админке, потом оплачивал через Prodamus.
   - Требовалось, чтобы заказ создавался автоматически после оплаты, а пользователь не вводил номер заказа и сумму.

2. **Реализация автоматизации:**
   - Генерация уникального номера заказа на backend.
   - Сохранение даты рождения и других данных до оплаты.
   - Формирование ссылки на оплату через API-инвойс Prodamus.
   - После оплаты заказ создаётся или обновляется автоматически, рассчитываются чакры, результат сохраняется.

3. **Проблемы с отображением суммы и номера заказа:**
   - Статическая форма Prodamus не поддерживает автозаполнение суммы и номера заказа через ссылку.
   - Описание (description) не отображается на платёжной странице.
   - Решение: использовать только индивидуальные ссылки из API-инвойса.
   - Если даже по индивидуальной ссылке сумма и номер заказа не видны — это ограничение формы/тарифа, нужно обращаться в поддержку Prodamus.

4. **Письмо в поддержку Prodamus:**
   - Был подготовлен шаблон письма с вопросами о том, как включить отображение суммы и номера заказа на странице оплаты.
   - Важно приложить индивидуальную ссылку из поля `url` ответа API-инвойса.

5. **Текущий итог:**
   - В проекте реализован эндпоинт `/generate_pay_url`, который напрямую создаёт инвойс через API Prodamus и возвращает индивидуальную ссылку на оплату.
   - Пользователь автоматически переходит по этой ссылке, сумма и номер заказа зашиты в ссылку.
   - Вебхук обрабатывает оплату и создаёт заказ в базе.
   - Если на странице оплаты не отображаются сумма и номер заказа — это ограничение Prodamus, и нужно решать через поддержку.

---

## Ключевые моменты для восстановления контекста

- Использовать только индивидуальные ссылки из API-инвойса Prodamus.
- Не отправлять пользователя на статическую форму.
- Если индивидуальная ссылка не отображает сумму и номер заказа — обращаться в поддержку Prodamus.
- Временно информировать пользователя о сумме и номере заказа в чате перед оплатой.

---

**Если потребуется восстановить детали интеграции — смотри этот файл!** 